# ADR-003: Structured English Block Parsing and EnBlock Integration

**Status:** Proposed  
**Date:** 2025-09-06  
**Authors:** Aaron Solomon

---

## Context

The English translation XML returned from GPT includes rich formatting and semantic markers provided by the translator based on custom instructions. Our existing parsing system **flattens this structure into concatenated text**, which leads to the following issues:

* Heading/subheading repetition and `<title>` ambiguity are mishandled.
* Lists, authors, and tables of contents are ignored.
* Inline formatting (`<i>`, `<b>`) is lost.
* Page-level EN aggregation works, but semantic structure is missing.

We want to **capture and preserve the full information set** at parse time so the viewer and downstream tooling can leverage it later without revisiting the raw XML. This requires introducing a structured representation of translation blocks.

---

## Decision

### 1. Introduce the EnBlock Dataclass

```python
from dataclasses import dataclass, field
from typing import Dict, Any, List, Literal

@dataclass
class EnBlock:
    type: Literal[
        "heading", "subheading", "paragraph",
        "list", "list_item", "author",
        "toc", "raw"
    ]
    text: str
    attrs: Dict[str, Any] = field(default_factory=dict)
    marks: List[str] = field(default_factory=list)  # e.g., ["italic", "bold"]
```

* **type** → semantic role derived from XML tag.
* **text** → normalized text for the block, preserving `<br/>` as `\n` inside `<p>`.
* **attrs** → arbitrary structured metadata, e.g.:
  * Lists: `{"ordered": True, "items": [...]}`
  * TOC: `{"items": [{"text": "..."}]}`
* **marks** → inline styling collected from `<i>` / `<b>` tags.

This enables a rich structured representation without committing the viewer to a particular rendering strategy.

---

### 2. Extend SectionBlock

SectionBlock gains a new field:

```python
@dataclass
class SectionBlock:
    aid: str
    en: str
    vi: str
    pagination: Dict[str, Any]
    en_blocks: List[EnBlock] = field(default_factory=list)
```

* `en` → concatenated full text of the section (unchanged).
* `en_blocks` → structured list of semantic blocks, preserving translator intent.

---

### 3. Parsing Strategy

#### Demote `<title>` and `<subtitle>`

* Section titles are authoritative from **metadata**.
* Demote `<title>` → "heading".
* Demote `<subtitle>` → "subheading".
* No attempt to infer section titles from XML content.

#### Tag Handling Rules

| Tag | EnBlock Type | Notes |
|-----|--------------|-------|
| `<p>` | "paragraph" | Preserves `<br/>` → `\n`. |
| `<br/>` | inline newline | No separate block; affects parent `<p>`. |
| `<title>` | "heading" | Treated as display heading only. |
| `<subtitle>` | "subheading" | Treated as display subheading only. |
| `<heading>` | "heading" | Equivalent to `<title>`. |
| `<author>` | "author" | Promotes to Section.author if missing; validated otherwise. |
| `<ul>` / `<ol>` | "list" | `attrs={"ordered": True/False, "items": [{"text": ...}]}`. |
| `<li>` | "list_item" | Typically nested into list.attrs.items. |
| `<TOC>` | "toc" | Captures items only; no linking yet (phase II). |
| `<i>` | inline mark | Adds "italic" to marks list for enclosing block. |
| `<b>` | inline mark | Adds "bold" to marks list for enclosing block. |
| `<notes>` | sidecar | No EnBlock emitted; stays in annotations dict. |
| `<translation-notes>` | sidecar | Same as `<notes>`. |

#### Example: Structured Blocks

```xml
<section>
  <title>The Role of Mindfulness</title>
  <author>Thích Nhất Hạnh</author>
  <p>Mindfulness is the <i>foundation</i> of happiness.<br/>It is also our refuge.</p>
  <ul>
    <li>Breathing</li>
    <li>Walking</li>
  </ul>
</section>
```

Yields:

```python
en_blocks = [
    EnBlock(type="heading", text="The Role of Mindfulness"),
    EnBlock(type="author", text="Thích Nhất Hạnh"),
    EnBlock(type="paragraph", text="Mindfulness is the foundation\nIt is also our refuge.", marks=["italic"]),
    EnBlock(type="list", text="", attrs={
        "ordered": False,
        "items": [
            {"text": "Breathing"},
            {"text": "Walking"}
        ]
    })
]
```

---

### 4. Validation Enhancements

Two new validation signals:

| Code | Level | Description |
|------|-------|-------------|
| `INFO_MULTIPLE_HEADINGS_IN_SECTION` | Info | If multiple heading EnBlocks exist within a section. |
| `WARN_AUTHOR_MISMATCH` | Warn | If XML `<author>` disagrees with metadata Section.author. |

This improves feedback while preserving human-in-the-loop editing.

---

### 5. Downstream Implications

* The **viewer** can choose whether to display structured en_blocks or fallback to the en concatenation.
* Search, pagination, and reconciliation remain based on Span and SectionBlock.en (unchanged).
* Future "TOC linking" logic will build on EnBlock(type="toc") once we've validated parsing.

---

## Alternatives Considered

* **Ignore tags** → simpler parser, but we'd lose the ability to reconstruct translator intent.
* **Inline marks only** → captures formatting but loses hierarchical meaning (lists, headings).
* **Full XML AST** → overly heavy for this stage; hard to integrate with Bundle.

---

## Status & Next Steps

**Prototype tasks**:

1. Add EnBlock dataclass.
2. Extend SectionBlock with en_blocks.
3. Refactor parse_en_translation_xml to populate en_blocks.
4. Simplify `<title>`/`<subtitle>` handling—no title inference.
5. Add italic/bold mark tracking.
6. Add new validator signals (AUTHOR_MISMATCH, MULTIPLE_HEADINGS_IN_SECTION).

---

## Consequences

* Rich semantic structure now extracted at parse time.
* Human editors get better leverage for cleanup (duplicate headings, mismatched authors).
* Viewer and NLP downstream have access to the **complete information set** without revisiting XML.
